name: Deploy to Production

# 1ã€å·²ç»ä½¿ç”¨sudo visudoæ·»åŠ å…å¯†é…ç½® 2ã€åˆ›å»ºå›æ»šæœºåˆ¶ï¼Œåœ¨éƒ¨ç½²å¤±è´¥åè‡ªåŠ¨å›æ»š
# è§¦å‘æ¡ä»¶ï¼šå½“ä»£ç æ¨é€åˆ° master åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches:
      - master

jobs:
  # é˜¶æ®µä¸€ï¼šæ„å»ºå¹¶æ¨é€ Docker é•œåƒ
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    # æ­¥éª¤ 2ï¼šå®‰è£… Docker Compose
    - name: Install Docker Compose
      run: |
        sudo apt-get update
        sudo apt-get install -y docker-compose

    # æ­¥éª¤ 3ï¼šç™»å½• DockerHub å®¹å™¨æ³¨å†Œè¡¨
    - name: Login to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push images
      env:
        POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        MONGO_USER: ${{ secrets.MONGO_USER }}
        MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
      run: |
        docker-compose -f docker-compose.prod.yml build
        docker-compose -f docker-compose.prod.yml push

  # é˜¶æ®µäºŒï¼šæœåŠ¡å™¨éƒ¨ç½²ï¼ˆä¾èµ–æ„å»ºé˜¶æ®µï¼‰
  deploy:
    runs-on: ubuntu-latest
    needs: [build]  # ç¡®ä¿å…ˆå®Œæˆé•œåƒæ„å»º
    steps:
    - uses: actions/checkout@v2

    - name: Set up environment variables
      run: |
        echo "POSTGRES_HOST=db" >> $GITHUB_ENV
        echo "POSTGRES_DB=videoeeg" >> $GITHUB_ENV
        echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> $GITHUB_ENV
        echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> $GITHUB_ENV
        echo "MONGO_URI=mongodb://${{ secrets.MONGO_USER }}:${{ secrets.MONGO_PASSWORD }}@mongodb:27017" >> $GITHUB_ENV
        echo "REDIS_HOST=redis" >> $GITHUB_ENV
        echo "REDIS_PORT=6379" >> $GITHUB_ENV

    - name: Deploy to CentOS 7 server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          set -e  # ä»»ä½•æ­¥éª¤å¤±è´¥ç«‹å³åœæ­¢
          DEPLOY_DIR="Xproject/EMOtestapp/video-player-app"
          
          # å®šä¹‰å›æ»šå‡½æ•°
          rollback() {
            echo "â€¼ï¸ Deployment failed! Rolling back..."
            cd $DEPLOY_DIR
            docker-compose down  # åœæ­¢æ–°å®¹å™¨
            docker-compose up -d  # å°è¯•é‡æ–°å¯åŠ¨æ—§æœåŠ¡
            exit 1
          }
          trap rollback ERR  # æ•è·é”™è¯¯è§¦å‘å›æ»š

          # å¼€å§‹éƒ¨ç½²
          cd $DEPLOY_DIR
          git fetch --all
          git reset --hard origin/master

          # è®°å½•å½“å‰å®¹å™¨çŠ¶æ€ï¼ˆç”¨äºå›æ»šï¼‰
          OLD_CONTAINERS=$(docker ps -aq)

          docker-compose pull  # æ‹‰å–æœ€æ–°é•œåƒï¼ˆæ¥è‡ªæ„å»ºé˜¶æ®µï¼‰
          docker-compose up -d db mongodb redis

          # æ•°æ®åº“å¥åº·æ£€æŸ¥ï¼ˆæ›¿ä»£ sleep 30ï¼‰
          echo "ğŸ” Checking database readiness..."
          timeout 60s bash -c 'until docker-compose exec db pg_isready; do sleep 2; done'
          timeout 60s bash -c 'until nc -z mongodb 27017; do sleep 2; done'
          timeout 60s bash -c 'until nc -z redis 6379; do sleep 2; done'

          # å¯åŠ¨åº”ç”¨æœåŠ¡
          docker-compose up -d app

          # æ—¥å¿—ç›‘æ§ï¼ˆæ£€æŸ¥åº”ç”¨æ˜¯å¦æ­£å¸¸å¯åŠ¨ï¼‰
          sleep 10  # ç»™åº”ç”¨å¯åŠ¨ç•™å‡ºæ—¶é—´
          if ! docker-compose logs app | grep -q "Application started"; then
            echo "âŒ App failed to start!"
            exit 1
          fi

          # æ¸…ç†æ—§å®¹å™¨
          if [ -n "$OLD_CONTAINERS" ]; then
            docker rm -f $OLD_CONTAINERS || true
          fi

          # é˜²ç«å¢™é…ç½®ï¼ˆéäº¤äº’å¼ sudoï¼‰
          echo ${{ secrets.SUDO_PASSWORD }} | sudo -S firewall-cmd --permanent --add-port=8080/tcp
          sudo firewall-cmd --reload
          sudo systemctl restart docker

          echo "âœ… Deployment successful!"