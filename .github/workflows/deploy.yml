name: Deploy to Production

# 触发条件：当代码推送到 master 分支时触发
on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest  # 使用最新的 Ubuntu 系统作为运行环境
    
    steps:
    # 步骤 1：检出代码到工作目录
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    # 步骤 2：设置 Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # 步骤 3：登录 DockerHub 容器注册表
    - name: Login to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 步骤 4：构建和推送 Docker 镜像
    - name: Build and push Docker images
      run: |
        #配置 Docker 镜像加速器
        echo '{"registry-mirrors": ["https://registry.cn-hangzhou.aliyuncs.com"]}' | sudo tee /etc/docker/daemon.json
        sudo systemctl daemon-reload
        sudo systemctl restart docker

        # 设置环境变量
        echo "DOCKER_BUILDKIT=1" >> $GITHUB_ENV
        
        # 构建和推送前端镜像
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/video-player-frontend:latest -f Dockerfile.frontend .
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/video-player-frontend:latest
        
        # 构建和推送后端镜像
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/video-player-backend:latest -f Dockerfile.backend .
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/video-player-backend:latest
        
        # 构建和推送 Nginx 镜像
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/video-player-nginx:latest -f Dockerfile.nginx .
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/video-player-nginx:latest
    
     # 步骤 5：通过 SSH 连接到生产服务器执行部署操作
    - name: Deploy to Production Server
      uses: appleboy/ssh-action@master
      with:
       host: ${{ secrets.SERVER_HOST }}
       username: ${{ secrets.SERVER_USERNAME }}
       password: ${{ secrets.SERVER_PASSWORD }}
       port: 22
       debug: true
       timeout: 60s
       command_timeout: 20m
       script: |
         # 增加调试信息
         echo "开始部署过程..."
                    pwd
                    whoami
          id

          # 确保目录存在
          if [ ! -d "$HOME/video-player-app" ]; then
            echo "创建部署目录..."
            sudo mkdir -p $HOME/video-player-app
            sudo chown $(whoami):$(whoami) $HOME/video-player-app
          fi

          # 检查是否是 Git 仓库
          if [ -d "$HOME/video-player-app/.git" ]; then
            echo "目录是 Git 仓库，执行 git pull..."
            cd $HOME/video-player-app
            git reset --hard origin/master
            git pull origin master
          else
            echo "目录不是 Git 仓库，清空并重新克隆..."
            rm -rf $HOME/video-player-app
            git clone https://github.com/Albert-XY/video-player-app.git "$HOME/video-player-app"
          fi

          # 进入项目目录
          cd "$HOME/video-player-app"

          # 备份 Docker Compose 文件
          timestamp=$(date +%Y%m%d%H%M%S)
          if [ -f docker-compose.prod.yml ]; then
            cp docker-compose.prod.yml docker-compose.prod.yml.backup.$timestamp
          fi

          # 生成 .env 文件（如果不存在）
          if [ ! -f .env ]; then
            echo "POSTGRES_DB=${POSTGRES_DB:-video_player}" > .env
            echo "POSTGRES_USER=${POSTGRES_USER:-postgres}" >> .env
            echo "POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
          fi

          # 配置 Docker 镜像加速器
          echo '{"registry-mirrors": ["https://registry.cn-hangzhou.aliyuncs.com"]}' | sudo tee /etc/docker/daemon.json
          echo "${{ secrets.SERVER_PASSWORD }}" | sudo -S systemctl daemon-reload
          echo "${{ secrets.SERVER_PASSWORD }}" | sudo -S systemctl restart docker

          # 登录 Docker Hub
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

          # 拉取最新 Docker 镜像（增加重试）
          for i in {1..5}; do
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/video-player-frontend:latest && break || sleep 10
          done
          for i in {1..5}; do
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/video-player-backend:latest && break || sleep 10
          done
          for i in {1..5}; do
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/video-player-nginx:latest && break || sleep 10
          done

          # 重新启动服务
          docker-compose -f docker-compose.prod.yml down
          docker-compose -f docker-compose.prod.yml up -d

          # 健康检查
          echo "等待服务启动..."
          sleep 30
          health_status=$(curl -s http://localhost/api/health || echo '{"status":"unhealthy"}')
          if [[ $health_status == *"healthy"* ]]; then
            echo "部署成功：服务健康状态正常"
          else
            echo "部署警告：健康检查失败，可能需要进一步调查"
            echo "$health_status"
            
            # 自动回滚
            if [ -f docker-compose.prod.yml.backup.$timestamp ]; then
              echo "正在回滚到之前的配置..."
              cp docker-compose.prod.yml.backup.$timestamp docker-compose.prod.yml
              docker-compose -f docker-compose.prod.yml down
              docker-compose -f docker-compose.prod.yml up -d
            fi
          fi

    # 步骤 6：通知部署结果
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "部署成功完成！"
        else
          echo "部署失败。请检查日志获取详细信息。"
        fi